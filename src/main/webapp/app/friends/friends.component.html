<div class="friends-root">
  <h1>Friends</h1>

  <!-- View all visible users -->
  <div [class]="search === '' ? 'dropdown transparent' : 'dropdown'" (focusin)="toggledialog()">
    <div class="searchBar">
      <input class="form-control mr-sm-2" type="search" placeholder="Search for users" aria-label="Search" [(ngModel)]="search" />
    </div>
    <div class="userList" *ngIf="search !== ''">
      <!-- Show friends -->
      <div *ngFor="let friend of friends">
        <div class="userCard" *ngIf="getDisplayName(friend.friendAppUser?.internalUser).toLowerCase().startsWith(search.toLowerCase())">
          <img [src]="friend.friendAppUser?.avatarURL || 'https://cse.iutoic-dhaka.edu/uploads/img/1601007481_1328.jpg'" alt="" />

          <div class="details">
            <p class="name">{{ getDisplayName(friend.friendAppUser?.internalUser) }}</p>
            <p>Friends from {{ since(friend.createdAt) }} ago</p>
          </div>

          <button type="submit" class="button secondary" (click)="delete(friend)" aria-label="unfriend">
            <fa-icon icon="xmark"></fa-icon>
          </button>
        </div>
      </div>
      <!-- Show new users -->
      <div *ngFor="let user of users">
        <div class="userCard" *ngIf="search != '' && getDisplayName(user?.internalUser).toLowerCase().startsWith(search.toLowerCase())">
          <img [src]="user?.avatarURL || 'https://cse.iutoic-dhaka.edu/uploads/img/1601007481_1328.jpg'" alt="" />

          <div class="details">
            <p class="name">{{ getDisplayName(user?.internalUser) }}</p>
          </div>

          <button type="submit" class="button secondary" (click)="block(user.id)" aria-label="block">
            <fa-icon icon="ban"></fa-icon>
          </button>

          <button type="submit" class="button primary" (click)="sendFriendRequest(user.id)" aria-label="send friend request">
            <fa-icon icon="plus"></fa-icon>
          </button>
        </div>
      </div>
      <!-- Show blocked users -->
      <div *ngFor="let user of blocked">
        <div class="userCard" *ngIf="search != '' && getDisplayName(user?.internalUser).toLowerCase().startsWith(search.toLowerCase())">
          <div class="d-flex gap-4 justify-content-center">
            <img [src]="user?.avatarURL || 'https://cse.iutoic-dhaka.edu/uploads/img/1601007481_1328.jpg'" alt="" />

            <div class="details">
              <p class="name">{{ getDisplayName(user?.internalUser) }}</p>
            </div>
          </div>

          <button type="submit" class="button secondary" (click)="unblock(user.id)" aria-label="unblock">
            <fa-icon icon="ban"></fa-icon>
            <p>Unblock</p>
          </button>
        </div>
      </div>
    </div>
  </div>

  <br />

  <!-- List recommendations -->
  <section *ngIf="recommendations && recommendations.length > 0">
    <h2>Friend Recommendations</h2>
    <div class="userList">
      <div class="userCard" *ngFor="let rec of recommendations">
        <div class="d-flex gap-4 justify-content-center">
          <img [src]="rec.aboutAppUser?.avatarURL || 'https://cse.iutoic-dhaka.edu/uploads/img/1601007481_1328.jpg'" alt="" />
          <div class="details">
            <p class="name">{{ getDisplayName(rec.aboutAppUser?.internalUser) }}</p>
            <p class="other">{{ toPercent(rec.similarity).toFixed(0) }}% similar</p>
          </div>
        </div>
        <button type="submit" class="button primary" (click)="sendFriendRequest(rec.aboutAppUser?.id)" aria-label="send friend request">
          <fa-icon icon="plus"></fa-icon>
        </button>
      </div>
    </div>
  </section>

  <!-- List friend requests -->
  <section *ngIf="friendRequests && friendRequests.length > 0">
    <h2>Friend Requests</h2>
    <div class="userList">
      <div class="userCard" *ngFor="let friendRequest of friendRequests">
        <div class="d-flex gap-4 justify-content-center">
          <img
            [src]="friendRequest.initiatingAppUser?.avatarURL || 'https://cse.iutoic-dhaka.edu/uploads/img/1601007481_1328.jpg'"
            alt=""
          />

          <div class="details">
            <p class="name">{{ getDisplayName(friendRequest.initiatingAppUser?.internalUser) }}</p>
            <p class="other mb-0">{{ since(friendRequest.createdAt) }} ago</p>
          </div>
        </div>

        <div class="d-flex gap-4">
          <button type="submit" class="button primary" (click)="accept(friendRequest.id)" aria-label="accept friend request">
            <span class="material-symbols-outlined">check</span>
            <!--          <fa-icon icon="check"></fa-icon>-->
          </button>
          <button type="submit" class="button secondary" (click)="reject(friendRequest.id)" aria-label="reject friend request">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- List friends -->
  <section *ngIf="friends && friends.length > 0">
    <h2>My Friends</h2>
    <div class="userList">
      <div class="userCard" *ngFor="let friend of friends">
        <div class="d-flex gap-4 justify-content-center">
          <img
            [src]="friend.friendAppUser?.avatarURL || 'https://cse.iutoic-dhaka.edu/uploads/img/1601007481_1328.jpg'"
            alt="Profile picture."
            alt=""
          />

          <div class="details">
            <p class="name">{{ getDisplayName(friend.friendAppUser?.internalUser) }}</p>
            <p *ngIf="friend.mostRecentSong">
              <a class="song-name" [href]="'https://open.spotify.com/track/' + friend.mostRecentSong.spotifyID" target="_blank">
                {{ friend.mostRecentSong.name
                }}{{ getArtistNames(friend.mostRecentSong) ? ' â€¢ ' + getArtistNames(friend.mostRecentSong) : '' }}
              </a>
              <br />
              <a class="album-name" [href]="'https://open.spotify.com/album/' + friend?.mostRecentSong?.album?.spotifyID" target="_blank">
                {{ friend.mostRecentSong?.album?.name }}</a
              >
            </p>
          </div>
        </div>

        <button type="submit" class="button secondary" (click)="delete(friend)" aria-label="unfriend">
          <fa-icon icon="xmark"></fa-icon>
        </button>
      </div>
    </div>
  </section>
</div>
